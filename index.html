<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engwerda Studios</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nicer look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A light gray background */
        }
        header {
            font-family: 'Playfair Display', serif;
        }
        /* A subtle transition for hover effects */
        .item, button {
            transition: all 0.2s ease-in-out;
        }
        /* Custom styles for the notification toast */
        #notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section -->
    <header class="bg-red-800 text-white p-6 text-center shadow-lg">
        <h1 class="text-4xl md:text-5xl font-bold">Engwerda Studios</h1>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-10">
            <p class="text-lg text-gray-500">Loading Studio...</p>
        </div>

        <!-- Login View -->
        <div id="login" class="hidden bg-white p-8 rounded-xl shadow-md max-w-sm mx-auto">
            <h2 class="text-2xl font-bold text-red-800 mb-6 text-center">Enter Password</h2>
            <div class="space-y-4">
                <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:outline-none">
                <button id="loginButton" class="w-full bg-red-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Enter
                </button>
            </div>
        </div>

        <!-- Studio & Admin View Container -->
        <div id="content-view" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-md">
            <!-- Breadcrumb Navigation -->
            <div id="breadcrumb" class="mb-4 text-gray-500"></div>
            
            <!-- Admin Controls (visible only to admin) -->
            <div id="admin-controls" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-red-800 mb-4">Admin Panel</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Add Folder -->
                    <div class="space-y-2">
                        <input type="text" id="folderName" placeholder="New Folder Name" class="w-full px-3 py-2 border rounded-md">
                        <button id="addFolderBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Add Folder</button>
                    </div>
                    <!-- Add Link -->
                    <div class="space-y-2">
                        <input type="text" id="linkName" placeholder="Link Name" class="w-full px-3 py-2 border rounded-md">
                        <input type="text" id="linkURL" placeholder="Link URL" class="w-full px-3 py-2 border rounded-md">
                        <button id="addLinkBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Add Link</button>
                    </div>
                </div>
            </div>

            <!-- File & Folder Display Area -->
            <div id="fileArea" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Items will be dynamically inserted here -->
            </div>
             <p id="empty-folder-msg" class="hidden text-center text-gray-500 py-8">This folder is empty.</p>

            <!-- Navigation Buttons -->
            <div class="mt-8 pt-6 border-t border-gray-200 flex items-center justify-between">
                <button id="backButton" class="bg-gray-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed">Back</button>
                <button id="logoutButton" class="bg-red-700 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-800">Logout</button>
            </div>
        </div>
    </main>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl translate-x-[120%] opacity-0">
        <p id="notification-text"></p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4" id="confirm-modal-title">Are you sure?</h3>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirm-modal-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        
        // Use provided Firebase config and App ID, with defaults for local testing
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'engwerda-studios-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // For detailed console logs

        // App state variables
        let fileStructure = { name: "Home", folders: [], links: [] };
        let currentPath = []; // An array of indices to navigate the structure
        let isAdmin = false;
        let unsubscribe; // To detach the Firestore listener on logout

        // --- DOM ELEMENT REFERENCES ---
        const DOMElements = {
            loading: document.getElementById('loading'),
            loginView: document.getElementById('login'),
            contentView: document.getElementById('content-view'),
            passwordInput: document.getElementById('password'),
            loginButton: document.getElementById('loginButton'),
            adminControls: document.getElementById('admin-controls'),
            fileArea: document.getElementById('fileArea'),
            breadcrumb: document.getElementById('breadcrumb'),
            backButton: document.getElementById('backButton'),
            logoutButton: document.getElementById('logoutButton'),
            addFolderBtn: document.getElementById('addFolderBtn'),
            addLinkBtn: document.getElementById('addLinkBtn'),
            folderNameInput: document.getElementById('folderName'),
            linkNameInput: document.getElementById('linkName'),
            linkURLInput: document.getElementById('linkURL'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notification-text'),
            emptyFolderMsg: document.getElementById('empty-folder-msg'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalText: document.getElementById('confirm-modal-text'),
            confirmModalCancel: document.getElementById('confirm-modal-cancel'),
            confirmModalConfirm: document.getElementById('confirm-modal-confirm'),
        };

        // --- AUTHENTICATION ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in, show the login screen to determine role (admin/user)
                console.log("User authenticated with UID:", user.uid);
                DOMElements.loading.style.display = 'none';
                DOMElements.loginView.style.display = 'block';
            } else {
                // User is signed out, attempt to sign in
                console.log("No user found, attempting sign-in...");
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showNotification("Error: Could not authenticate.", "error");
                }
            }
        });

        // --- FIRESTORE DATABASE ---

        /**
         * Attaches a real-time listener to the Firestore document.
         */
        function attachFirestoreListener() {
            // FIX: Corrected the document path to have an even number of segments.
            // A document path must point to a document within a collection.
            // The path now correctly points to a document 'fileSystem' inside a collection 'content'.
            const docRef = doc(db, `artifacts/${appId}/public/data/content`, "fileSystem");
            
            // Unsubscribe from any previous listener before creating a new one
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Firestore data received:", docSnap.data().structure);
                    // Ensure the structure is valid before assigning
                    if (docSnap.data().structure) {
                        fileStructure = docSnap.data().structure;
                    }
                } else {
                    // If no document exists, create one with the default structure
                    console.log("No document found, creating initial structure.");
                    saveStructure(); 
                }
                render(); // Re-render the UI with the new data
            }, (error) => {
                console.error("Firestore listener error:", error);
                showNotification("Error connecting to the database.", "error");
            });
        }

        /**
         * Saves the current file structure to Firestore.
         */
        async function saveStructure() {
            if (!auth.currentUser) {
                showNotification("You must be logged in to save changes.", "error");
                return;
            }
            try {
                // FIX: Corrected the document path to match the listener's path.
                const docRef = doc(db, `artifacts/${appId}/public/data/content`, "fileSystem");
                await setDoc(docRef, { structure: fileStructure });
                console.log("Structure saved to Firestore.");
            } catch (error) {
                console.error("Error saving to Firestore:", error);
                showNotification("Failed to save changes.", "error");
            }
        }

        // --- RENDERING LOGIC ---

        /**
         * Main render function to update the entire UI based on state.
         */
        function render() {
            const currentFolder = getCurrentFolder();
            if (!currentFolder) {
                console.error("Could not find current folder at path:", currentPath);
                // Reset to root if path is invalid and try again
                currentPath = [];
                render();
                return;
            }
            
            // Render breadcrumbs for navigation
            renderBreadcrumb();

            // Clear the file area
            DOMElements.fileArea.innerHTML = '';
            
            const items = [...(currentFolder.folders || []), ...(currentFolder.links || [])];

            if (items.length === 0) {
                DOMElements.emptyFolderMsg.style.display = 'block';
            } else {
                DOMElements.emptyFolderMsg.style.display = 'none';
                 // Render folders
                (currentFolder.folders || []).forEach((folder, index) => {
                    DOMElements.fileArea.appendChild(createItemElement(folder, 'folder', index));
                });

                // Render links
                (currentFolder.links || []).forEach((link, index) => {
                    DOMElements.fileArea.appendChild(createItemElement(link, 'link', index));
                });
            }

            // Update button states
            DOMElements.backButton.disabled = currentPath.length === 0;
        }

        /**
         * Creates an HTML element for a folder or link.
         * @param {object} item - The folder or link object.
         * @param {string} type - 'folder' or 'link'.
         * @param {number} index - The index of the item in its array.
         * @returns {HTMLElement} The created DOM element.
         */
        function createItemElement(item, type, index) {
            const isFolder = type === 'folder';
            const wrapper = document.createElement('div');
            wrapper.className = 'item relative group flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg text-center cursor-pointer hover:border-red-500 hover:bg-red-50';

            // SVG Icon for visual distinction
            const icon = isFolder 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`;
            
            wrapper.innerHTML = `
                ${icon}
                <span class="break-words w-full font-semibold text-gray-700">${item.name}</span>
            `;

            // Click handler for navigation or opening links
            wrapper.addEventListener('click', () => {
                if (isFolder) {
                    currentPath.push(index);
                    render();
                } else {
                    window.open(item.url, "_blank");
                }
            });

            // If admin, add a delete button
            if (isAdmin) {
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `&times;`; // 'x' symbol for delete
                deleteBtn.className = 'absolute top-1 right-1 h-6 w-6 bg-red-500 text-white rounded-full flex items-center justify-center font-bold opacity-0 group-hover:opacity-100 hover:bg-red-700';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent folder navigation when clicking delete
                    handleDeleteItem(type, index);
                };
                wrapper.appendChild(deleteBtn);
            }

            return wrapper;
        }

        /**
         * Renders the breadcrumb navigation path for easy navigation.
         */
        function renderBreadcrumb() {
            DOMElements.breadcrumb.innerHTML = '';
            let path = fileStructure;
            
            const homeLink = document.createElement('span');
            homeLink.textContent = 'Home';
            homeLink.className = 'cursor-pointer hover:underline';
            homeLink.onclick = () => { currentPath = []; render(); };
            DOMElements.breadcrumb.appendChild(homeLink);

            currentPath.forEach((folderIndex, pathIndex) => {
                if (path && path.folders && path.folders[folderIndex]) {
                    path = path.folders[folderIndex];
                    const separator = document.createElement('span');
                    separator.textContent = ' / ';
                    separator.className = 'mx-1';
                    DOMElements.breadcrumb.appendChild(separator);

                    const pathLink = document.createElement('span');
                    pathLink.textContent = path.name;
                    pathLink.className = 'cursor-pointer hover:underline';
                    pathLink.onclick = () => {
                        currentPath = currentPath.slice(0, pathIndex + 1);
                        render();
                    };
                    DOMElements.breadcrumb.appendChild(pathLink);
                }
            });
        }


        // --- EVENT HANDLERS & ACTIONS ---

        /**
         * Checks password and sets the view (Studio or Admin).
         */
        function handleLogin() {
            const pw = DOMElements.passwordInput.value;
            if (pw === "Austin") {
                isAdmin = false;
                showContentView();
            } else if (pw === "Admin") {
                isAdmin = true;
                showContentView();
            } else {
                showNotification("Wrong password. Please try again.", "error");
            }
            DOMElements.passwordInput.value = '';
        }

        /**
         * Switches the view to the main content area after successful login.
         */
        function showContentView() {
            DOMElements.loginView.style.display = 'none';
            DOMElements.contentView.style.display = 'block';
            DOMElements.adminControls.style.display = isAdmin ? 'block' : 'none';
            attachFirestoreListener(); // Start listening for data from Firestore
        }

        /**
         * Handles adding a new folder.
         */
        function handleAddFolder() {
            const name = DOMElements.folderNameInput.value.trim();
            if (!name) {
                showNotification("Please enter a folder name.", "error");
                return;
            }
            const currentFolder = getCurrentFolder();
            if (!currentFolder.folders) currentFolder.folders = [];
            currentFolder.folders.push({ name: name, folders: [], links: [] });
            DOMElements.folderNameInput.value = "";
            saveStructure();
            showNotification(`Folder "${name}" added.`, "success");
        }

        /**
         * Handles adding a new link.
         */
        function handleAddLink() {
            const name = DOMElements.linkNameInput.value.trim();
            const url = DOMElements.linkURLInput.value.trim();
            if (!name || !url) {
                showNotification("Please enter both a name and a URL.", "error");
                return;
            }
            const currentFolder = getCurrentFolder();
            if (!currentFolder.links) currentFolder.links = [];
            currentFolder.links.push({ name: name, url: url });
            DOMElements.linkNameInput.value = "";
            DOMElements.linkURLInput.value = "";
            saveStructure();
            showNotification(`Link "${name}" added.`, "success");
        }
        
        /**
         * Handles deleting an item (folder or link) after confirmation.
         * @param {string} type - 'folder' or 'link'.
         * @param {number} index - The index of the item to delete.
         */
        async function handleDeleteItem(type, index) {
            const currentFolder = getCurrentFolder();
            const itemArray = type === 'folder' ? currentFolder.folders : currentFolder.links;
            const itemName = itemArray[index].name;

            const confirmed = await showConfirm(`Are you sure you want to delete "${itemName}"?`);
            if (confirmed) {
                itemArray.splice(index, 1);
                saveStructure();
                showNotification(`"${itemName}" was deleted.`, "success");
            }
        }

        /**
         * Navigates one level up in the folder structure.
         */
        function handleGoBack() {
            if (currentPath.length > 0) {
                currentPath.pop();
                render();
            }
        }

        /**
         * Logs the user out and returns to the login screen.
         */
        function handleLogout() {
            currentPath = [];
            isAdmin = false;
            if (unsubscribe) unsubscribe(); // Stop listening to Firestore to prevent memory leaks
            DOMElements.contentView.style.display = 'none';
            DOMElements.loginView.style.display = 'block';
        }


        // --- UTILITY FUNCTIONS ---

        /**
         * Traverses the fileStructure using the currentPath to get the current folder object.
         * @returns {object} The current folder object.
         */
        function getCurrentFolder() {
            let current = fileStructure;
            for (const index of currentPath) {
                if (current && current.folders && current.folders[index]) {
                    current = current.folders[index];
                } else {
                    return null; // Invalid path
                }
            }
            return current;
        }

        /**
         * Displays a notification toast.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' for styling.
         */
        function showNotification(message, type = 'success') {
            DOMElements.notificationText.textContent = message;
            const notification = DOMElements.notification;
            notification.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-xl translate-x-[120%] opacity-0 ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'}`;
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-[120%]', 'opacity-0');
                notification.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            // Animate out after 3 seconds
            setTimeout(() => {
                notification.classList.remove('translate-x-0', 'opacity-100');
                notification.classList.add('translate-x-[120%]', 'opacity-0');
            }, 3000);
        }

        /**
         * Shows a custom confirmation dialog.
         * @param {string} text - The confirmation message.
         * @returns {Promise<boolean>} - A promise that resolves to true if confirmed, false otherwise.
         */
        function showConfirm(text) {
            return new Promise((resolve) => {
                DOMElements.confirmModalText.textContent = text;
                DOMElements.confirmModal.classList.remove('hidden');

                const cancelHandler = () => {
                    DOMElements.confirmModal.classList.add('hidden');
                    DOMElements.confirmModalConfirm.removeEventListener('click', confirmHandler);
                    DOMElements.confirmModalCancel.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                const confirmHandler = () => {
                    DOMElements.confirmModal.classList.add('hidden');
                    DOMElements.confirmModalConfirm.removeEventListener('click', confirmHandler);
                    DOMElements.confirmModalCancel.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                DOMElements.confirmModalCancel.addEventListener('click', cancelHandler, { once: true });
                DOMElements.confirmModalConfirm.addEventListener('click', confirmHandler, { once: true });
            });
        }

        // --- INITIAL SETUP & EVENT LISTENERS ---
        
        DOMElements.loginButton.addEventListener('click', handleLogin);
        DOMElements.passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        DOMElements.addFolderBtn.addEventListener('click', handleAddFolder);
        DOMElements.addLinkBtn.addEventListener('click', handleAddLink);
        DOMElements.backButton.addEventListener('click', handleGoBack);
        DOMElements.logoutButton.addEventListener('click', handleLogout);

    </script>
</body>
</html>
