<script>
    // --- GLOBAL STATE & CONFIG ---

    // The key used to track login status
    const AUTH_KEY = 'engwerda-studio-auth';
    // The key to store the file structure in localStorage
    const DATA_KEY = 'engwerda-studio-data';

    // Initial, default file structure if none exists in localStorage
    const defaultFileStructure = {
        name: "Home",
        folders: [
            {
                name: "Private",
                folders: [
                    {
                        name: "Bike Bandits",
                        folders: [],
                        links: [
                            {
                                name: "Script",
                                url: "https://docs.google.com/document/d/1Q4dh3V8z6DUza9l331LyEPGyIy-qSbzd3ORSbtXCQhs/edit?tab=t.0"
                            },
                            {
                                name: "Shot List",
                                url: "https://docs.google.com/document/d/1X_BeJ45gtb0zVUEQFVsgdZscoiP7e_0ly3xWsU7Gmmk/edit?tab=t.0"
                            },
                            {
                                name: "Schedule",
                                url: "https://docs.google.com/document/d/1TA4FZHU0iQCPhZDHmvu3mhnSjYGSsywPVJpFWyC_0ZE/edit?tab=t.0"
                            },
                            {
                                name: "Props",
                                url: "https://docs.google.com/document/d/1IrQvtBGHxI8PvRzZ3BNE5Tv4mbqO4fhB3_d0RYR7pvo/edit?tab=t.0"
                            },
                            {
                                name: "Costumes",
                                url: "https://docs.google.com/document/d/1LTg4zOwkyLEB4dHSE_49WGNFELEY8NRK7xtDJm3eZpw/edit?tab=t.0"
                            },
                            {
                                name: "Marketing",
                                url: "https://docs.google.com/document/d/1x3-bH6vlgCi9phXOrsy9hGymUTeDGX20HzU6ofVGT9g/edit?tab=t.0"
                            },
                            {
                                name: "Cast Resources",
                                url: "https://docs.google.com/document/d/1M_d6HgmRIae6kCS54wItWdAuyPzwvVPoRG8XONd5R1g/edit?tab=t.0"
                            },
                            {
                                name: "Form",
                                url: "https://docs.google.com/forms/d/1zHXmQ8s17qJsDZb-mZ4w784DhJmNi1l0zglP6_UNIPA/edit#response=ACYDBNjiP1iZoccmphWNg2s2JuYKyPT07jhr3BsSCDRjBZ-ohbCgGssF0NN8cLUcXpkRW8A"
                            }
                        ]
                    }
                ],
                links: []
            }
        ],
        links: []
    };

    let fileStructure = {};
    let currentPath = []; // An array of indices to navigate the structure
    let isAdmin = false;
    
    // --- Define DOMElements in the global scope ---
    let DOMElements = {};

    // --- VIEW MANAGEMENT & AUTHENTICATION ---

    function showPublicView() {
        DOMElements.publicView.classList.remove('hidden');
        DOMElements.blogView.classList.add('hidden');
        DOMElements.loginView.classList.add('hidden');
        DOMElements.contentView.classList.add('hidden');
    }

    function showBlogView() {
        DOMElements.publicView.classList.add('hidden');
        DOMElements.blogView.classList.remove('hidden');
        DOMElements.loginView.classList.add('hidden');
        DOMElements.contentView.classList.add('hidden');
        renderBlog();
    }

    function showLoginModal() {
        DOMElements.loginView.classList.remove('hidden');
    }

    function hideLoginModal() {
        DOMElements.loginView.classList.add('hidden');
    }

    function handleLogin() {
        const pw = DOMElements.passwordInput.value;
        DOMElements.passwordInput.value = '';

        if (pw === "Austin") {
            isAdmin = false;
            localStorage.setItem(AUTH_KEY, "user");
            showContentView();
        } else if (pw === "Admin") {
            isAdmin = true;
            localStorage.setItem(AUTH_KEY, "admin");
            showContentView();
        } else {
            showNotification("Wrong password. Please try again.", "error");
        }
    }

    function showContentView() {
        DOMElements.loginView.classList.add('hidden');
        DOMElements.publicView.classList.add('hidden');
        DOMElements.blogView.classList.add('hidden');
        DOMElements.contentView.classList.remove('hidden');
        DOMElements.adminControls.style.display = isAdmin ? 'block' : 'none';
        const privateFolderIndex = fileStructure.folders.findIndex(f => f.name === 'Private');
        if (privateFolderIndex !== -1) {
            currentPath = [privateFolderIndex];
        } else {
            currentPath = [];
        }
        render();
    }

    function handleGoBack() {
        if (currentPath.length > 0) {
            currentPath.pop();
            render();
        }
    }

    function handleLogout() {
        currentPath = [];
        isAdmin = false;
        localStorage.removeItem(AUTH_KEY);
        showPublicView();
    }

    // --- DATA MANAGEMENT (localStorage) ---

    function loadStructure() {
        const storedData = localStorage.getItem(DATA_KEY);
        if (storedData) {
            fileStructure = JSON.parse(storedData);
        } else {
            fileStructure = defaultFileStructure;
            saveStructure();
        }
    }

    function saveStructure() {
        localStorage.setItem(DATA_KEY, JSON.stringify(fileStructure));
    }
    
    // --- RENDERING LOGIC ---
    
    function render() {
        const currentFolder = getCurrentFolder();
        if (!currentFolder) {
            console.error("Could not find current folder at path:", currentPath);
            currentPath = [];
            render();
            return;
        }
        
        renderBreadcrumb();
        DOMElements.fileArea.innerHTML = '';
        
        const items = [...(currentFolder.folders || []), ...(currentFolder.links || [])];
        DOMElements.emptyFolderMsg.style.display = items.length === 0 ? 'block' : 'none';

        (currentFolder.folders || []).forEach((folder, index) => {
            DOMElements.fileArea.appendChild(createItemElement(folder, 'folder', index));
        });

        (currentFolder.links || []).forEach((link, index) => {
            DOMElements.fileArea.appendChild(createItemElement(link, 'link', index));
        });

        DOMElements.backButton.disabled = currentPath.length === 0;
    }

    async function renderBlog() {
        const blogContainer = document.getElementById('blogContainer');
        blogContainer.innerHTML = `
            <div class="flex justify-center items-center h-48">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-red-600 rounded-full animate-spin"></div>
            </div>
        `;
        
        let imagesLoaded = false;
        let imageCounter = 1;
        const fileExtensions = ['jpg', 'jpeg', 'png', 'gif'];

        for (const ext of fileExtensions) {
            while (true) {
                const imageUrl = `blog/${imageCounter}.${ext}`;
                try {
                    const response = await fetch(imageUrl, { method: 'HEAD' });
                    if (response.ok) {
                        if (!imagesLoaded) {
                            blogContainer.innerHTML = '';
                            imagesLoaded = true;
                        }
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrl;
                        imgElement.alt = `Blog post image ${imageCounter}`;
                        imgElement.className = 'w-full mb-6 rounded-lg shadow-md';
                        blogContainer.appendChild(imgElement);
                        imageCounter++;
                    } else {
                        break;
                    }
                } catch (error) {
                    break;
                }
            }
            if (imagesLoaded) break;
        }

        if (!imagesLoaded) {
            blogContainer.innerHTML = `<p class="text-center text-gray-500 py-8">No blog posts found yet. Check back soon!</p>`;
        }
    }


    function createItemElement(item, type, index) {
        const isFolder = type === 'folder';
        const wrapper = document.createElement('div');
        wrapper.className = 'item relative group flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg text-center cursor-pointer hover:border-red-500 hover:bg-red-50';

        const icon = isFolder
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`
            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`;
        
        wrapper.innerHTML = `
            ${icon}
            <span class="break-words w-full font-semibold text-gray-700">${item.name}</span>
        `;

        wrapper.addEventListener('click', () => {
            if (isFolder) {
                currentPath.push(index);
                render();
            } else {
                window.open(item.url, "_blank");
            }
        });

        if (isAdmin) {
            const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = `&times;`;
        deleteBtn.className = 'absolute top-1 right-1 h-6 w-6 bg-red-500 text-white rounded-full flex items-center justify-center font-bold opacity-0 group-hover:opacity-100 hover:bg-red-700';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            handleDeleteItem(type, index);
        };
        wrapper.appendChild(deleteBtn);
        }
        return wrapper;
    }

    function renderBreadcrumb() {
        DOMElements.breadcrumb.innerHTML = '';
        let path = fileStructure;
        
        const homeLink = document.createElement('span');
        homeLink.textContent = 'Home';
        homeLink.className = 'cursor-pointer hover:underline';
        homeLink.onclick = () => { currentPath = []; render(); };
        DOMElements.breadcrumb.appendChild(homeLink);

        currentPath.forEach((folderIndex, pathIndex) => {
            if (path && path.folders && path.folders[folderIndex]) {
                path = path.folders[folderIndex];
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.className = 'mx-1';
                DOMElements.breadcrumb.appendChild(separator);

                const pathLink = document.createElement('span');
                pathLink.textContent = path.name;
                pathLink.className = 'cursor-pointer hover:underline';
                pathLink.onclick = () => {
                    currentPath = currentPath.slice(0, pathIndex + 1);
                    render();
                };
                DOMElements.breadcrumb.appendChild(pathLink);
            }
        });
    }
    
    // --- EVENT HANDLERS & ACTIONS ---
    
    function handleAddFolder() {
        const name = DOMElements.folderNameInput.value.trim();
        if (!name) {
            showNotification("Please enter a folder name.", "error");
            return;
        }
        const currentFolder = getCurrentFolder();
        if (!currentFolder.folders) currentFolder.folders = [];
        currentFolder.folders.push({ name: name, folders: [], links: [] });
        DOMElements.folderNameInput.value = "";
        saveStructure();
        render();
        showNotification(`Folder "${name}" added.`, "success");
    }

    function handleAddLink() {
        const name = DOMElements.linkNameInput.value.trim();
        const url = DOMElements.linkURLInput.value.trim();
        if (!name || !url) {
            showNotification("Please enter both a name and a URL.", "error");
            return;
        }
        const currentFolder = getCurrentFolder();
        if (!currentFolder.links) currentFolder.links = [];
        currentFolder.links.push({ name: name, url: url });
        DOMElements.linkNameInput.value = "";
        DOMElements.linkURLInput.value = "";
        saveStructure();
        render();
        showNotification(`Link "${name}" added.`, "success");
    }
    
    async function handleDeleteItem(type, index) {
        const currentFolder = getCurrentFolder();
        const itemArray = type === 'folder' ? currentFolder.folders : currentFolder.links;
        const itemName = itemArray[index].name;

        const confirmed = await showConfirm(`Are you sure you want to delete "${itemName}"?`);
        if (confirmed) {
            itemArray.splice(index, 1);
            saveStructure();
            render();
            showNotification(`"${itemName}" was deleted.`, "success");
        }
    }

    // --- UTILITY FUNCTIONS ---
    
    function getCurrentFolder() {
        let current = fileStructure;
        for (const index of currentPath) {
            if (current && current.folders && current.folders[index]) {
                current = current.folders[index];
            } else {
                return null;
            }
        }
        return current;
    }

    function showNotification(message, type = 'success') {
        DOMElements.notificationText.textContent = message;
        const notification = DOMElements.notification;
        notification.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-xl translate-x-[120%] opacity-0 ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'}`;
        
        setTimeout(() => {
            notification.classList.remove('translate-x-[120%]', 'opacity-0');
            notification.classList.add('translate-x-0', 'opacity-100');
        }, 10);

        setTimeout(() => {
            notification.classList.remove('translate-x-0', 'opacity-100');
            notification.classList.add('translate-x-[120%]', 'opacity-0');
        }, 3000);
    }

    function showConfirm(text) {
        return new Promise((resolve) => {
            DOMElements.confirmModalText.textContent = text;
            DOMElements.confirmModal.classList.remove('hidden');

            const cancelHandler = () => {
                DOMElements.confirmModal.classList.add('hidden');
                DOMElements.confirmModalConfirm.removeEventListener('click', confirmHandler);
                DOMElements.confirmModalCancel.removeEventListener('click', cancelHandler);
                resolve(false);
            };

            const confirmHandler = () => {
                DOMElements.confirmModal.classList.add('hidden');
                DOMElements.confirmModalConfirm.removeEventListener('click', confirmHandler);
                DOMElements.confirmModalCancel.removeEventListener('click', cancelHandler);
                resolve(true);
            };

            DOMElements.confirmModalCancel.addEventListener('click', cancelHandler, { once: true });
            DOMElements.confirmModalConfirm.addEventListener('click', confirmHandler, { once: true });
        });
    }
    
    // This function encapsulates all the initial setup and event listener attachments.
    function initializeApp() {
        // Assign elements to the globally declared DOMElements object
        DOMElements.loading = document.getElementById('loading');
        DOMElements.publicView = document.getElementById('public-view');
        DOMElements.blogView = document.getElementById('blog-view');
        DOMElements.showLoginBtn = document.getElementById('showLoginBtn');
        DOMElements.hideLoginBtn = document.getElementById('hideLoginBtn');
        DOMElements.loginView = document.getElementById('login');
        DOMElements.contentView = document.getElementById('content-view');
        DOMElements.passwordInput = document.getElementById('password');
        DOMElements.loginButton = document.getElementById('loginButton');
        DOMElements.adminControls = document.getElementById('admin-controls');
        DOMElements.fileArea = document.getElementById('fileArea');
        DOMElements.breadcrumb = document.getElementById('breadcrumb');
        DOMElements.backButton = document.getElementById('backButton');
        DOMElements.logoutButton = document.getElementById('logoutButton');
        DOMElements.addFolderBtn = document.getElementById('addFolderBtn');
        DOMElements.addLinkBtn = document.getElementById('addLinkBtn');
        DOMElements.folderNameInput = document.getElementById('folderName');
        DOMElements.linkNameInput = document.getElementById('linkName');
        DOMElements.linkURLInput = document.getElementById('linkURL');
        DOMElements.notification = document.getElementById('notification');
        DOMElements.notificationText = document.getElementById('notification-text');
        DOMElements.emptyFolderMsg = document.getElementById('empty-folder-msg');
        DOMElements.confirmModal = document.getElementById('confirm-modal');
        DOMElements.confirmModalText = document.getElementById('confirm-modal-text');
        DOMElements.confirmModalCancel = document.getElementById('confirm-modal-cancel');
        DOMElements.confirmModalConfirm = document.getElementById('confirm-modal-confirm');

        // Event Listeners
        DOMElements.showLoginBtn.addEventListener('click', showLoginModal);
        DOMElements.hideLoginBtn.addEventListener('click', hideLoginModal);
        DOMElements.loginButton.addEventListener('click', handleLogin);
        DOMElements.passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        if (DOMElements.addFolderBtn) DOMElements.addFolderBtn.addEventListener('click', handleAddFolder);
        if (DOMElements.addLinkBtn) DOMElements.addLinkBtn.addEventListener('click', handleAddLink);
        if (DOMElements.backButton) DOMElements.backButton.addEventListener('click', handleGoBack);
        if (DOMElements.logoutButton) DOMElements.logoutButton.addEventListener('click', handleLogout);

        // Initial app state setup
        loadStructure();
        const loggedInAs = localStorage.getItem(AUTH_KEY);
        if (loggedInAs === "admin") {
            isAdmin = true;
            showContentView();
        } else if (loggedInAs === "user") {
            isAdmin = false;
            showContentView();
        } else {
            showPublicView();
        }
    }
    
    // --- Call initializeApp when the DOM is ready ---
    document.addEventListener('DOMContentLoaded', initializeApp);

</script>
